# Vibe Kanban - Development Docker Compose
# This setup provides hot-reload for both frontend and backend during development

services:
  # Backend service (Rust with hot reload via cargo watch)
  backend:
    build:
      context: .
      dockerfile: Dockerfile.dev
      target: backend-dev
    container_name: vibe-kanban-backend
    working_dir: /app
    command: cargo watch -w crates -x 'run --bin server'
    environment:
      - RUST_LOG=debug
      - HOST=0.0.0.0
      - PORT=${BACKEND_PORT:-8080}
      - DISABLE_WORKTREE_ORPHAN_CLEANUP=1
      - DATABASE_URL=sqlite:/app/dev_assets/db.sqlite
    ports:
      - "${BACKEND_PORT:-8080}:${BACKEND_PORT:-8080}"
    volumes:
      # Mount source code for hot reload
      - ./crates:/app/crates:cached
      - ./shared:/app/shared:cached
      - ./Cargo.toml:/app/Cargo.toml:cached
      - ./Cargo.lock:/app/Cargo.lock:cached
      # Mount development assets
      - ./dev_assets:/app/dev_assets
      - ./dev_assets_seed:/app/dev_assets_seed:ro
      # Git repositories
      - repos_data:/repos
      # Cargo cache for faster builds
      - cargo_cache:/usr/local/cargo/registry
      - cargo_git:/usr/local/cargo/git
      - target_cache:/app/target
    networks:
      - vibe-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:${BACKEND_PORT:-8080}/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # Frontend service (React + Vite with HMR)
  frontend:
    build:
      context: .
      dockerfile: Dockerfile.dev
      target: frontend-dev
    container_name: vibe-kanban-frontend
    working_dir: /app/frontend
    command: npm run dev -- --host 0.0.0.0 --port ${FRONTEND_PORT:-3000}
    environment:
      - VITE_API_URL=http://localhost:${BACKEND_PORT:-8080}
      - VITE_OPEN=false
    ports:
      - "${FRONTEND_PORT:-3000}:${FRONTEND_PORT:-3000}"
    volumes:
      # Mount frontend source for HMR
      - ./frontend:/app/frontend:cached
      - ./shared:/app/shared:cached
      # Node modules cache
      - frontend_node_modules:/app/frontend/node_modules
    networks:
      - vibe-network
    depends_on:
      backend:
        condition: service_healthy
    restart: unless-stopped

volumes:
  # Persistent data volumes
  repos_data:
    name: vibe-kanban-repos
  # Cache volumes for faster rebuilds
  cargo_cache:
    name: vibe-kanban-cargo-cache
  cargo_git:
    name: vibe-kanban-cargo-git
  target_cache:
    name: vibe-kanban-target-cache
  frontend_node_modules:
    name: vibe-kanban-frontend-node-modules

networks:
  vibe-network:
    name: vibe-kanban-network
    driver: bridge
